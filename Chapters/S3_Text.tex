\documentclass[a4paper,12pt]{article}

\input{suppinfo_preambule}

%%%%%  AJOUT  FRANCIS %%%%%%%%%%%%%%%%%%%%%%%%%55
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{graphicx}

\usepackage{amssymb}
\usepackage{mathrsfs}

\usepackage{color} 
\newcommand{\tr}[1]{{#1}}

%%%%%% FIN AJOUT FRANCIS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Add an S3
\renewcommand{\thetable}{S3.\arabic{table}}%
\renewcommand{\thefigure}{S3.\arabic{figure}}%
\renewcommand{\theequation}{S3.\arabic{equation}}
\renewcommand{\thesection}{S3.\arabic{section}}%

\begin{document}
\begin{flushleft}
{\Large
\textbf\newline{\textbf{S3 Text -- Solution of optimal control problem\footnote{Supporting Information of "\input{title}"}}}
}
\newline
\input{authors_affil}
\end{flushleft}
\section{Statement of the problem}

We consider the dimensionless system defined by Eqs~\ref{eq:pdefnondim}-\ref{eq:rdefnondim} in the main text, which are here repeated for clarity:
\begin{equation}{\label{eq:model}}
\begin{aligned}
\frac{d\hat{p}}{d\hat{t}} &= (1-\hat{r})\, E_M - (1+\hat{p})\, \hat{r} \, \frac{\hat{p}}{K+\hat{p}}, \\
\frac{d\hat{r}}{d\hat{t}} &= \hat{r} \frac{\hat{p}}{K + \hat{p}} \, (\alpha (\hat{t}) - \hat{r}).
\end{aligned}
\end{equation}

\tr{As stated in the section \textit{Biomass maximization as an optimal control problem} in the main text, the objective of this study is to maximize the growth rate on an interval $[0,\tau]$ after a nutrient upshift. With Eq.~\ref{S1.eq:supp_growthrate_adim} in \ref{S1_Text}, we have
 
\begin{equation*}
\hat{\mu}= \hat{r}\, \dfrac{\hat{p}}{K+\hat{p}}.
\end{equation*}
In order to avoid boundary effects occurring over finite time intervals, notably the depletion of precursors just before $\tau$, we solve the optimal control problem over an infinite horizon ($\tau \rightarrow \infty$).} Consider the set of admissible controls
\[
\mathcal{U}=\{\alpha:\mathbb{R} \rightarrow [0,1] \ \mid \ \alpha(\cdot) \ \mathrm{measurable}\}.
\]
The optimization problem can then be stated as follows:
\begin{equation}\label{Prob}
\tr{\alpha_{opt} = \arg \max_{\alpha \in \mathcal{U}} J(\alpha)\equiv \int_0^{+\infty} \hat{r}(\hat{t}) \frac{\hat{p}(\hat{t})}{K + \hat{p}(\hat{t})} d\hat{t} ,} 
\end{equation}
where $(\hat{p}(\hat{t}),\hat{r}(\hat{t}))$ is the unique solution of Eq.~\ref{eq:model} starting at a given point $(\hat{p}_0,\hat{r}_0)\in \Omega \equiv \mathbb{R}^+_* \times (0,1)$ for a given control $\alpha\in \mathcal{U}$.

\tr{Given that the performance index $J(\alpha)$ diverges, we actually consider \textit{overtaking optimality}~\cite{carlson_infinite_1991}.
Consider the performance index of the trajectory $x(\cdot)$ emanating from $x_0$ and generated by $u(\cdot)$ defined for any $T\geq 0$ by
$$
J_T(x_0,u(\cdot))=\int_0^T f_0(x(t),u(t),t)dt.
$$
A trajectory $x^*(\cdot)$ emanating from $x_0$ and generated by $u^*(\cdot)$ is said to be overtaking optimal if for any other trajectory $x(\cdot)$ emanating from $x_0$ and generated by $u(\cdot)$ the following holds
$$
\liminf_{T\rightarrow\infty} \left\lbrace J_T(x_0,u^*(\cdot)) - J_T(x_0,u(\cdot))\right\rbrace\geq 0.
$$
Roughly speaking, a trajectory is overtaking optimal if "the performance index catches up with the performance index of any other trajectory"~\cite{carlson_infinite_1991}.}

\section{Maximum Principle}
Necessary conditions on optimal trajectories can be obtained by the Infinite Horizon Maximum Principle~\cite{carlson_infinite_1991}.
Let $H(\hat{p},\hat{r},\lambda_p,\lambda_r,\lambda_0,\alpha)$ be the Hamiltonian of the system, defined by
\[
H(\cdot) \equiv \lambda_p\, E_M\, (1-\hat{r}) - \hat{r}\, \dfrac{\hat{p}}{K+\hat{p}}\left[\lambda_p (1+\hat{p}) +\lambda_r\, \hat{r} +\lambda_0\right] + \alpha \, \lambda_r \, \hat{r}\, \frac{\hat{p}}{K+\hat{p}}.
\]
Moreover, let $\alpha$ be an optimal control, and $\hat{x}(\cdot)=(\hat{p}(\cdot),\hat{r}(\cdot))$ the associated trajectory.
Then, there exists $\lambda_0 \leq 0$ and an absolutely continuous map $\lambda=(\lambda_p,\lambda_r):[0,+\infty) \rightarrow \mathbb{R}^2$
such that $(\lambda,\lambda_0)\neq0$, and
\begin{align}
\dot{\lambda}_p\, \tr{=-\frac{\partial H}{\partial \hat p}}&= \hat{r} \, \frac{K}{(K+\hat{p})^2}\, \left[\lambda_p \, (1+\hat{p}) +\lambda_r\, ( \hat{r}-\alpha) + \lambda_0\right] + \hat{r}\, \frac{\hat{p}}{K+\hat{p}}\, \lambda_p, \label{eq:adjoint_p}\\
 \dot{\lambda}_r\, \tr{=-\frac{\partial H}{\partial \hat r}}&= \lambda_p\, E_M +\frac{\hat{p}}{K+\hat{p}} \, \left[\lambda_p \, (1+\hat{p}) +\lambda_r\, (2 \hat{r}-\alpha) +\lambda_0\right] \label{eq:adjoint_r}.
\end{align}
The maximization condition is given by:
\begin{equation}{\label{eq:PMP}}
\begin{aligned}
&\alpha(\hat{t}) \in \arg\ max_{v \in [0,1]} H(\hat{x}(\hat{t}),\lambda(\hat{t}),\lambda_0,v), \\ &\mathrm{almost}\ \mathrm{everywhere}\ \mathrm{on}\ [0,+\infty).
\end{aligned}
\end{equation}

An extremal trajectory is a quadruplet $(\hat{x}(\cdot),\lambda(\cdot),\lambda_0,\alpha(\cdot))$ satisfying Eqs~\ref{eq:model}-\ref{eq:PMP}. \tr{The extremal is said to be normal (resp. abnormal) if $\lambda_0<0$ (resp. $\lambda_0=0$). In the normal case, we normalize the adjoint vector so that $\lambda_0=-1$.}\\

From Eq.~\ref{eq:PMP}, it follows that the control strategy is given by the sign of the \textit{switching function} $\phi(\cdot) \equiv \lambda_r \, \hat{r}\, \hat{p}/(K+\hat{p})$, that is,
\[
\begin{cases}
\alpha=1 \iff \phi(\cdot) >0,\\
\alpha=0 \iff \phi(\cdot)<0.
\end{cases}
\]

\tr{Finally, given that the system is autonomous, the Hamiltonian is conserved along any extremal trajectory.}

\section{Characterization of singular arcs}

Whenever $\phi$ is vanishing over a time interval, we say that the trajectory is \textit{singular}.
We will now characterize such trajectories.
If $I=[\hat{t}_1,\hat{t}_2]$ is a singular arc, we have $\phi(\hat{t})=\dot{\phi}(\hat{t})=0$, for all $\hat{t}\in[\hat{t}_1,\hat{t}_2]$, that is, $\lambda_r(\hat{t})=0$ and $\dot\lambda_r(\hat{t})=0$. 

\tr{For abnormal extremal} \tr{trajectories}, \tr{we get $\lambda_p(\hat{t})=0$, in contradiction with the Maximum Principle, so there is no singular arc.} \tr{An abnormal extremal trajectory is therefore a concatenation of bang arcs.}

\tr{For normal extremal} \tr{trajectories}, using additionally that $H$ is constant along an extremal trajectory, we obtain that $\lambda_p$ is constant along a singular arc. \tr{By combining $\dot \lambda_p=0$ and $\dot \lambda_r=0$, we obtain} $\hat{p}(\hat{t})=\sqrt{E_M\, K}=\hat{p}_{opt}^*$. Using $d\hat{p}/d\hat{t}=0$, we finally get $\hat{r}(\hat{t})=\hat{r}_{opt}^*$.
Thus, the singular arc is the optimal steady state, corresponding to a singular control \tr{$\alpha(\hat{t})=\alpha_{opt}^*$, with $\alpha_{opt}^*$} depending on $E_M$ (\ref{S1_Text}).

A necessary condition of optimality for a singular arc is given by the Kelley condition~\cite{borisov_fullers_2000}.
We must differentiate $\phi$ with respect to $\hat{t}$ until $\alpha$ appears in the derivative. Along a singular arc, we obtain for $q=2$:
$$
(-1)^q\frac{\partial}{\partial\alpha}\frac{d^{2q}}{d\hat{t}^{2q}}\phi(\hat{t})<0,
$$
satisfying the Kelley condition necessary for optimality. Given that the singular arc is of second order, an optimal trajectory can enter into the singular arc only by a \textit{chattering arc} (also called the Fuller's phenomenon, \textit{i.e.}, an arc with an infinite number of switches~\cite{borisov_fullers_2000,marchal_chattering_2013}). \\


\tr{\section{Analysis of the adjoint system}
Recalling that a switch corresponds to a change of sign of $\lambda_r$, the analysis of the adjoint system (\tr{Eqs~\ref{eq:adjoint_p}-\ref{eq:adjoint_r}}) may be useful to characterize the switches of extremal trajectories. 

First, \tr{for the abnormal case, we can easily determine in the phase-plane the possible transitions between the four regions defined by the axes (see Fig.~\ref{fig-adj}). A trajectory can cross at most twice the $\lambda_p$-axis, so}  we conclude that an abnormal extremal cannot have more than two switches. Thus, an abnormal extremal is a concatenation of at most three bang arcs ($\alpha(t)=0$ or $\alpha(t)=1$). When  $\alpha(t)=0$ or $\alpha(t)=1$ for a long time, the growth rate tends to zero. We therefore conclude that  abnormal extremal trajectories are not optimal.

Secondly, for the normal case, after the first switch, a trajectory with two consecutive switches in the regions $\{(\hat{p},\hat{r})\in \Omega \mid \hat{p}<\hat{p}_{opt}^*\}$ or $\{(\hat{p},\hat{r})\in \Omega \mid \hat{p}>\hat{p}_{opt}^*\}$ is not} \tr{possible, as shown in Fig.~\ref{fig-adj}. Therefore, such a trajectory is not optimal given that it does not fulfill the conditions given by the Maximum Principle.
We conclude that if the optimal trajectory has a concatenation of bang arcs, the switches must alternatingly occur in the regions  $\{(\hat{p},\hat{r})\in \Omega \mid \hat{p}<\hat{p}_{opt}^*\}$ and $\{(\hat{p},\hat{r})\in \Omega \mid \hat{p}>\hat{p}_{opt}^*\}$.}

\begin{figure}[h]
\centering
\includegraphics[width=0.35\textwidth]{Fig/adj2ab.eps} 
\includegraphics[width=0.6\textwidth]{Fig/adj2.eps} 
\caption{\textbf{Transitions between regions in the phase-plane for the adjoint system.} A switch occurs when a trajectory crosses the $\lambda_p$-axis. \tr{ Left: abnormal case. An extremal trajectory cannot have more than two switches. Right: normal case.} $(\lambda_p^s,0)$ corresponds to the singular arc.  After the first switch, an extremal trajectory cannot have two consecutive switches if it stays in the region $\{(\hat{p},\hat{r})\in \Omega \mid \hat{p}<\hat{p}_{opt}^*\}$ or $\{(\hat{p},\hat{r})\in \Omega \mid \hat{p}>\hat{p}_{opt}^*\}$.}
\label{fig-adj}                               
\end{figure} 


\section{Optimal trajectories}

From the Maximum Principle, we have shown that the optimal trajectory is a concatenation of bang arcs ($\alpha(t)=0$ or $\alpha(t)=1$) and possibly a singular arc corresponding to the optimal steady state $(\hat{p}(\hat{t}),\hat{r}(\hat{t}))=(\hat{p}_{opt}^*,\hat{r}_{opt}^*)$. Moreover, if the optimal trajectory has a singular arc, it must enter it through a chattering arc (\textit{i.e.}, with an infinite number of switches between $\alpha=0$ and $\alpha=1$).

These elements motivate the supposition that optimal solutions consist in a transient (chattering arc) towards the optimal steady state, after which they remain there (until the next change of environment). The chattering arc can be characterized by a switching curve $\hat{p}\mapsto\varphi(\hat{p})$ which passes through the optimal steady state.
Defining $A_0$ and $A_1$ the regions above and below $\varphi$ in the $(\hat{p},\hat{r})$-plane, respectively, we conjecture that the following feedback control law is optimal: 
%The simplest way to reach the optimal steady-state is thus two arcs, either 0-1 or 1-0 depending on the initial conditions. More precisely, let $\phi_0$ and $\phi_1$ be defined as the the trajectories solution of System \eqref{model} backward in time starting at $(p_{opt}^*,r_{opt}^*)$ with respectively $\alpha=0$ and $\alpha=1$. Given $\phi=\phi_0 \cup \phi_1$, we define $A_0$ and $A_1$ the regions above and below $\phi$ in the plane $(p,r)$. 


\begin{equation}\label{control-opt}
\begin{cases}
\alpha(\hat{t})=0 \ \textrm{if} \ (\hat{p}(\hat{t}),\hat{r}(\hat{t}))\in A_0,\\
\alpha(\hat{t})=1 \ \textrm{if} \ (\hat{p}(\hat{t}),\hat{r}(\hat{t}))\in A_1,\\
\alpha(\hat{t})=\alpha_{opt} \ \textrm{if} \ (\hat{p}(\hat{t}),\hat{r}(\hat{t}))=(\hat{p}_{opt}^*,\hat{r}_{opt}^*).
\end{cases}
\end{equation}


\tr{Loosely speaking, the chattering arc corresponds to a spiral composed of bang arcs wrapping around the optimal steady state,} \tr{where the switches alternatingly occur} \tr{in the regions  $\{(\hat{p},\hat{r})\in \Omega \mid \hat{p}<\hat{p}_{opt}^*\}$ and $\{(\hat{p},\hat{r})\in \Omega \mid \hat{p}>\hat{p}_{opt}^*\}$, in line with the analysis of the adjoint system.}
This is a first hint that the proposed control strategy is optimal. Moreover, our conjecture is also in line with the \textit{turnpike property}:
Tr√©lat and Zuazua~\cite{trelat_turnpike_2015} have shown that, for quite a generic class of systems, the optimal strategy consists in staying at the optimal steady state (after a short transient).

\tr{As explained in the \textit{Methods} section of the main text, we} numerically solved the optimal control problem by the direct method using the \texttt{bocop} software~\cite{bonnans_bocop_2012}. 
It is important to stress that the optimization process was performed without any preliminary assumptions on the characteristics of the optimal trajectory. 
The fact that the numerical solution verifies the Maximum Principle (\textit{i.e.}, the singular arc corresponds to the optimal steady state) and the Kelley condition (\textit{i.e.}, the presence of a chattering arc)
tends to confirm that the control strategy of Eq.~\ref{control-opt} is optimal. As an aside, we note that due to the fact that numerical optimization was performed for a finite horizon, we actually obtained a second chattering arc escaping from the singular arc at the end of the simulation.  This is a classical property of the turnpike strategy: the optimal trajectory leaves the optimal steady state just before the end of the time interval of interest, in our case consuming almost all precursors. This arc was removed from the plot in Fig.~\ref{fig:optimalcontrol}, because it does not occur with an infinite horizon and is therefore a numerical artifact for this study.

\bibliographystyle{unsrt}
\bibliography{references}

\end{document}
